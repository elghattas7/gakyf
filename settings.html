<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="settings">Paramètres - Gestion Association</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>

    <div id="sidebarContainer"></div>

    <div class="main-content">
        <div id="header"></div>

        <main class="p-8 fade-in">
            <div class="mb-8">
                <h2 class="page-title" data-i18n="settings">Paramètres Avancés</h2>
                <p class="text-gray-500 mt-1" data-i18n="settings_subtitle">Configuration système et gestion</p>
            </div>

            <!-- System Configuration -->
            <div class="card p-6 mb-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4" data-i18n="system_config">Configuration Système</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="app_name">Nom de
                            l'application</label>
                        <input type="text" id="appName" class="input-modern" value="Kafil Al Yatim">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="default_language">Langue
                            par défaut</label>
                        <select id="defaultLanguage" class="input-modern">
                            <option value="fr">Français</option>
                            <option value="ar">العربية</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4">
                    <button onclick="settingsModule.saveSystemConfig()" class="btn btn-primary">
                        <span data-i18n="save">Enregistrer</span>
                    </button>
                </div>
            </div>

            <!-- Backup & Restore -->
            <div class="card p-6 mb-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4" data-i18n="backup_restore">Sauvegarde & Restauration
                </h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-4 bg-blue-50 rounded-lg">
                        <div>
                            <p class="font-medium text-gray-800" data-i18n="create_backup">Créer une sauvegarde</p>
                            <p class="text-sm text-gray-600" data-i18n="backup_description">Télécharger une copie
                                complète de la base de données</p>
                        </div>
                        <button onclick="settingsModule.createBackup()" class="btn btn-secondary">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10">
                                </path>
                            </svg>
                            <span data-i18n="download">Télécharger</span>
                        </button>
                    </div>
                    <div class="p-4 bg-yellow-50 rounded-lg">
                        <p class="font-medium text-gray-800 mb-2" data-i18n="last_backup">Dernière sauvegarde</p>
                        <p class="text-sm text-gray-600" id="lastBackupDate">Aucune sauvegarde</p>
                    </div>
                </div>
            </div>

            <!-- Data Management -->
            <div class="card p-6 mb-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4" data-i18n="data_management">Gestion des Données</h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div>
                            <p class="font-medium text-gray-800" data-i18n="database_stats">Statistiques de la base</p>
                            <div class="text-sm text-gray-600 mt-2 space-y-1" id="dbStats">
                                <p>Chargement...</p>
                            </div>
                        </div>
                        <button onclick="settingsModule.loadDatabaseStats()" class="btn btn-secondary">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                </path>
                            </svg>
                        </button>
                    </div>
                    <div class="flex items-center justify-between p-4 bg-red-50 rounded-lg">
                        <div>
                            <p class="font-medium text-gray-800" data-i18n="clear_old_logs">Nettoyer les anciens logs
                            </p>
                            <p class="text-sm text-gray-600" data-i18n="clear_logs_description">Supprimer les logs de
                                plus de 1 an</p>
                        </div>
                        <button onclick="settingsModule.clearOldLogs()" class="btn btn-danger">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                </path>
                            </svg>
                            <span data-i18n="clean">Nettoyer</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- User Management -->
            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4" data-i18n="user_management">Gestion des Utilisateurs
                </h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                                    data-i18n="login">Login</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                                    data-i18n="full_name">Nom</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                                    data-i18n="role">Rôle</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                                    data-i18n="created_at">Créé le</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/translations.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/layout.js"></script>

    <script>
        const settingsModule = {
            async init() {
                await auth.requireAdmin();
                await layout.initLayout('settings.html');
                await this.loadDatabaseStats();
                await this.loadUsers();
            },

            async saveSystemConfig() {
                const appName = document.getElementById('appName').value;
                const defaultLanguage = document.getElementById('defaultLanguage').value;

                try {
                    // Save to localStorage for now
                    localStorage.setItem('app_name', appName);
                    localStorage.setItem('default_language', defaultLanguage);

                    utils.showNotification('Configuration enregistrée', 'success');
                } catch (e) {
                    console.error('Error saving config:', e);
                    utils.showNotification('Erreur lors de l\'enregistrement', 'error');
                }
            },

            async createBackup() {
                utils.showLoader();
                try {
                    // Fetch all data from all tables
                    const tables = ['veuves', 'orphelins', 'dons', 'aides', 'audit_logs'];
                    const backup = {
                        timestamp: new Date().toISOString(),
                        version: '1.0',
                        data: {}
                    };

                    for (const table of tables) {
                        const { data, error } = await supabase.from(table).select('*');
                        if (error) throw error;
                        backup.data[table] = data;
                    }

                    // Download as JSON
                    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();

                    // Sauvegarder la date dans Supabase
                    await supabase
                        .from('system_settings')
                        .upsert([
                            { setting_key: 'last_backup', setting_value: new Date().toISOString() }
                        ], { onConflict: 'setting_key' });

                    this.updateLastBackupDate();

                    utils.showNotification('Sauvegarde créée avec succès', 'success');
                } catch (e) {
                    console.error('Backup error:', e);
                    utils.showNotification('Erreur lors de la sauvegarde', 'error');
                } finally {
                    utils.hideLoader();
                }
            },

            updateLastBackupDate() {
                // Charger depuis Supabase
                supabase
                    .from('system_settings')
                    .select('setting_value')
                    .eq('setting_key', 'last_backup')
                    .single()
                    .then(({ data }) => {
                        const elem = document.getElementById('lastBackupDate');
                        if (data && data.setting_value) {
                            elem.textContent = utils.formatDateTime(data.setting_value);
                        }
                    });
            },

            async loadDatabaseStats() {
                try {
                    const tables = ['veuves', 'orphelins', 'dons', 'aides', 'audit_logs'];
                    const stats = [];

                    for (const table of tables) {
                        const { count, error } = await supabase
                            .from(table)
                            .select('*', { count: 'exact', head: true });

                        if (!error) {
                            stats.push(`${table}: ${count} enregistrements`);
                        }
                    }

                    document.getElementById('dbStats').innerHTML = stats.map(s => `<p>${s}</p>`).join('');
                } catch (e) {
                    console.error('Error loading stats:', e);
                }
            },

            async clearOldLogs() {
                const result = await Swal.fire({
                    title: 'Confirmer la suppression',
                    text: 'Supprimer les logs de plus de 1 an ?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Supprimer',
                    cancelButtonText: 'Annuler'
                });

                if (!result.isConfirmed) return;

                try {
                    const oneYearAgo = new Date();
                    oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);

                    const { error } = await supabase
                        .from('audit_logs')
                        .delete()
                        .lt('created_at', oneYearAgo.toISOString());

                    if (error) throw error;

                    utils.showNotification('Logs nettoyés avec succès', 'success');
                    await this.loadDatabaseStats();
                } catch (e) {
                    console.error('Error clearing logs:', e);
                    utils.showNotification('Erreur lors du nettoyage', 'error');
                }
            },

            async loadUsers() {
                try {
                    const { data, error } = await supabase
                        .from('profiles')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (error) throw error;

                    const tbody = document.getElementById('usersTableBody');
                    if (!data || data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4">Aucun utilisateur</td></tr>';
                        return;
                    }

                    tbody.innerHTML = data.map(user => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 text-sm text-gray-900">${user.email}</td>
                            <td class="px-6 py-4 text-sm text-gray-900">${user.full_name || '-'}</td>
                            <td class="px-6 py-4 text-sm text-gray-900">${user.role || '-'}</td>
                            <td class="px-6 py-4 text-sm text-gray-500">${utils.formatDate(user.created_at)}</td>
                        </tr>
                    `).join('');
                } catch (e) {
                    console.error('Error loading users:', e);
                }
            }
        };

        settingsModule.init();
        settingsModule.updateLastBackupDate();
    </script>
</body>

</html>