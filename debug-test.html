<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de D√©bogage - Chargement des Donn√©es</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold mb-6 text-gray-800">üîç Test de D√©bogage - Chargement des Donn√©es</h1>

        <div id="results" class="space-y-4">
            <div class="text-gray-500">Chargement des tests...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>

    <script>
        async function runDiagnostics() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            function addResult(title, status, details) {
                const statusColor = status === 'success' ? 'green' : status === 'error' ? 'red' : 'yellow';
                const statusIcon = status === 'success' ? '‚úÖ' : status === 'error' ? '‚ùå' : '‚ö†Ô∏è';

                resultsDiv.innerHTML += `
                    <div class="border-l-4 border-${statusColor}-500 bg-${statusColor}-50 p-4 rounded">
                        <h3 class="font-bold text-${statusColor}-800">${statusIcon} ${title}</h3>
                        <pre class="mt-2 text-sm text-gray-700 overflow-auto">${details}</pre>
                    </div>
                `;
            }

            // Test 1: V√©rifier la connexion Supabase
            try {
                addResult('Configuration Supabase', 'success',
                    `URL: ${supabase.supabaseUrl}\nCl√© configur√©e: Oui`);
            } catch (e) {
                addResult('Configuration Supabase', 'error', e.message);
            }

            // Test 2: V√©rifier la session utilisateur
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                if (error) throw error;

                if (session) {
                    addResult('Session Utilisateur', 'success',
                        `Email: ${session.user.email}\nID: ${session.user.id}\nR√¥le (metadata): ${session.user.user_metadata?.role || 'Non d√©fini'}`);
                } else {
                    addResult('Session Utilisateur', 'error', 'Aucune session active - Utilisateur non connect√©');
                }
            } catch (e) {
                addResult('Session Utilisateur', 'error', e.message);
            }

            // Test 3: V√©rifier le profil utilisateur
            try {
                const profile = await window.supabaseClient.getCurrentUserProfile();
                if (profile) {
                    addResult('Profil Utilisateur', 'success',
                        JSON.stringify(profile, null, 2));
                } else {
                    addResult('Profil Utilisateur', 'error',
                        'Profil non trouv√© dans la table profiles');
                }
            } catch (e) {
                addResult('Profil Utilisateur', 'error', e.message);
            }

            // Test 4: V√©rifier canWrite()
            try {
                const canWrite = await window.supabaseClient.canWrite();
                addResult('Permission canWrite()', canWrite ? 'success' : 'warning',
                    `Peut √©crire: ${canWrite}`);
            } catch (e) {
                addResult('Permission canWrite()', 'error', e.message);
            }

            // Test 5: Tester la requ√™te orphelins
            try {
                const { data, error, count } = await supabase
                    .from('orphelins')
                    .select('*, veuves(nom_complet)', { count: 'exact' });

                if (error) throw error;

                addResult('Requ√™te Orphelins', 'success',
                    `Nombre d'orphelins: ${count || data?.length || 0}\nPremier r√©sultat: ${JSON.stringify(data?.[0] || 'Aucun', null, 2)}`);
            } catch (e) {
                addResult('Requ√™te Orphelins', 'error',
                    `Message: ${e.message}\nCode: ${e.code}\nD√©tails: ${e.details || 'N/A'}\nHint: ${e.hint || 'N/A'}`);
            }

            // Test 6: Tester la requ√™te veuves
            try {
                const { data, error, count } = await supabase
                    .from('veuves')
                    .select('*', { count: 'exact' });

                if (error) throw error;

                addResult('Requ√™te Veuves', 'success',
                    `Nombre de veuves: ${count || data?.length || 0}\nPremier r√©sultat: ${JSON.stringify(data?.[0] || 'Aucun', null, 2)}`);
            } catch (e) {
                addResult('Requ√™te Veuves', 'error',
                    `Message: ${e.message}\nCode: ${e.code}\nD√©tails: ${e.details || 'N/A'}\nHint: ${e.hint || 'N/A'}`);
            }

            // Test 7: Tester la requ√™te dons
            try {
                const { data, error } = await supabase
                    .from('dons')
                    .select('*')
                    .limit(1);

                if (error) throw error;

                addResult('Requ√™te Dons', 'success',
                    `Nombre de dons (sample): ${data?.length || 0}`);
            } catch (e) {
                addResult('Requ√™te Dons', 'error',
                    `Message: ${e.message}\nCode: ${e.code}`);
            }

            // Test 8: V√©rifier les politiques RLS
            addResult('Politiques RLS', 'warning',
                'Si les requ√™tes ci-dessus √©chouent avec des erreurs de permission, v√©rifiez les politiques RLS dans Supabase:\n' +
                '1. Allez dans Authentication > Policies\n' +
                '2. Assurez-vous que les tables ont des politiques SELECT activ√©es\n' +
                '3. Les politiques doivent autoriser les utilisateurs authentifi√©s √† lire les donn√©es');
        }

        // Ex√©cuter les diagnostics au chargement
        window.addEventListener('DOMContentLoaded', runDiagnostics);
    </script>
</body>

</html>