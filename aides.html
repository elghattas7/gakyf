<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="aids">Gestion des Aides - Gestion Association</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> -->
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>

    <div id="sidebarContainer"></div>

    <div class="main-content">
        <div id="header"></div>

        <main class="p-8 fade-in">
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
                <div>
                    <h2 class="page-title" data-i18n="aids">Programmes & Aides</h2>
                    <p class="text-gray-500 mt-1" data-i18n="aids_management_subtitle">Gérez les programmes d'assistance
                        et les attributions</p>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-secondary" onclick="aidesModule.exportList()" data-i18n="download_list">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4">
                            </path>
                        </svg>
                        <span data-i18n="download_list">Télécharger la liste</span>
                    </button>
                    <button class="btn btn-secondary" onclick="addNewProgram()" data-i18n="new_program">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span data-i18n="new_program">Nouveau Programme</span>
                    </button>
                    <button class="btn btn-primary" onclick="window.location.href='aide-form.html'">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span data-i18n="assign_aid_btn">Attribuer une Aide</span>
                    </button>
                </div>
            </div>

            <!-- Stats Résumées -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="card p-5 border-l-4 border-blue-500">
                    <p class="text-sm text-gray-500 font-medium uppercase" data-i18n="assigned_total_year">Total
                        Attribué (Année)</p>
                    <h3 id="totalYearAides" class="text-2xl font-bold text-gray-800 mt-1">- €</h3>
                </div>
                <div class="card p-5 border-l-4 border-green-500">
                    <p class="text-sm text-gray-500 font-medium uppercase" data-i18n="active_beneficiaries">
                        Bénéficiaires Actifs</p>
                    <h3 id="activeBeneficiaries" class="text-2xl font-bold text-gray-800 mt-1">-</h3>
                </div>
                <div class="card p-5 border-l-4 border-purple-500">
                    <p class="text-sm text-gray-500 font-medium uppercase" data-i18n="last_aid">Dernière Aide</p>
                    <h3 id="lastAidAmount" class="text-2xl font-bold text-gray-800 mt-1">- €</h3>
                    <p id="lastAidDate" class="text-xs text-gray-400 mt-1">-</p>
                </div>
            </div>

            <!-- Programmes Actifs -->
            <h3 class="text-lg font-bold text-gray-800 mb-4" data-i18n="available_programs">Programmes d'Aide
                Disponibles</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10" id="programmesContainer">
                <!-- Rempli par JS -->
                <div class="col-span-4 text-center py-8" data-i18n="loading_dots">Chargement...</div>
            </div>

            <!-- Historique Attributions -->
            <div class="card">
                <div class="p-5 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="font-bold text-gray-800">Historique des Attributions</h3>
                    <div class="flex gap-2">
                        <input type="date" class="input-modern py-1 px-3 text-sm w-auto">
                    </div>
                </div>

                <div class="table-container border-none shadow-none rounded-t-none">
                    <table class="table-modern">
                        <thead>
                            <tr>
                                <th data-i18n="prog_nature">Nature / Programme</th>
                                <th data-i18n="beneficiary">Bénéficiaire</th>
                                <th data-i18n="type_column">Type</th>
                                <th data-i18n="amount">Montant</th>
                                <th data-i18n="date">Date</th>
                                <th data-i18n="actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="attributionsTableBody">
                            <!-- JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/translations.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/layout.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- <script src="js/pdf-fonts.js"></script> -->
    <script src="js/export-utils.js"></script>

    <script>
        const aidesModule = {
            async init() {
                await auth.protectPage();
                await auth.checkPagePermission(['admin', 'président', 'vice-président', 'secrétaire', 'trésorier', 'conseiller', 'gestionnaire', 'membre']);
                await layout.initLayout('aides.html');

                const canWrite = await auth.canWrite();
                const addButtons = document.querySelectorAll('button[onclick*="aide-form.html"], button[onclick*="addNewProgram()"]');
                addButtons.forEach(btn => {
                    if (!canWrite) btn.classList.add('hidden');
                });

                this.loadProgrammes();
                this.loadAttributions();
                this.loadStats();
            },

            allAttributions: [],

            async exportList() {
                const format = await exportUtils.promptExportFormat();
                if (!format) return;

                if (format === 'excel') {
                    const headers = [
                        '#',
                        i18n.t('prog_nature') || 'Programme',
                        i18n.t('beneficiary') || 'Bénéficiaire',
                        i18n.t('type_column') || 'Type',
                        i18n.t('amount') || 'Montant',
                        i18n.t('date') || 'Date',
                        i18n.t('status') || 'Statut'
                    ];

                    const rows = this.allAttributions.map((a, index) => [
                        index + 1,
                        a.nature_aide || a.programmes_aide?.nom_programme || '-',
                        (a.veuves?.nom_complet || a.orphelins?.nom_complet || '-'),
                        i18n.t(a.id_veuve ? 'widow' : 'orphan'),
                        String(a.montant),
                        utils.formatDate(a.date_aide)
                    ]);

                    const data = [headers, ...rows];
                    exportUtils.exportToExcel(data, 'liste_attributions', 'Attributions');
                } else if (format === 'word') {
                    const headers = [
                        '#',
                        i18n.t('prog_nature') || 'Programme',
                        i18n.t('beneficiary') || 'Bénéficiaire',
                        i18n.t('type_column') || 'Type',
                        i18n.t('amount') || 'Montant',
                        i18n.t('date') || 'Date',
                        i18n.t('status') || 'Statut'
                    ];

                    const rows = this.allAttributions.map((a, index) => [
                        String(index + 1),
                        a.nature_aide || a.programmes_aide?.nom_programme || '-',
                        (a.veuves?.nom_complet || a.orphelins?.nom_complet || '-'),
                        i18n.t(a.id_veuve ? 'widow' : 'orphan'),
                        String(a.montant),
                        utils.formatDate(a.date_aide)
                    ]);

                    const data = [headers, ...rows];
                    await exportUtils.exportToWord(data, 'liste_attributions', 'Historique des Attributions');
                } else {
                    // PDF
                    try {
                        utils.showLoader();
                        const isArabic = i18n.currentLang === 'ar';
                        const align = isArabic ? 'right' : 'left';
                        const title = i18n.t('history_attributions') || 'Historique des Attributions';
                        const dateStr = new Date().toLocaleDateString();

                        const letterSpacing = isArabic ? 'letter-spacing: 0.5px;' : '';

                        let htmlTable = `
                            <div dir="${isArabic ? 'rtl' : 'ltr'}" style="font-family: sans-serif; padding: 20px; ${letterSpacing}">
                                <style>
                                    table { border-collapse: collapse; width: 100%; }
                                    th, td { padding: 8px; border: 1px solid #c7d2fe; text-align: ${align}; }
                                </style>
                                <div style="text-align: center; margin-bottom: 20px;">
                                    <h1 style="color: #4f46e5; font-size: 24px; margin-bottom: 5px;">${title}</h1>
                                    <p style="color: #666;">${dateStr}</p>
                                </div>
                                <table style="width: 100%; font-size: 10px;">
                                    <thead>
                                        <tr style="background-color: #e0e7ff;">
                                            <th style="width: 5%">#</th>
                                            <th style="width: 25%">${i18n.t('prog_nature') || 'Nature'}</th>
                                            <th style="width: 30%">${i18n.t('beneficiary') || 'Bénéficiaire'}</th>
                                            <th style="width: 15%">${i18n.t('amount') || 'Montant'} (€)</th>
                                            <th style="width: 25%">${i18n.t('date') || 'Date'}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;

                        this.allAttributions.forEach((a, index) => {
                            const bg = index % 2 === 0 ? '#fff' : '#f5f7ff';
                            const beneficiaire = a.veuves?.nom_complet || a.orphelins?.nom_complet || '-';
                            const nature = a.nature_aide || a.programmes_aide?.nom_programme || '-';
                            const montantDH = utils.convertAmount(a.montant, 'EUR', 'DH');

                            htmlTable += `
                                <tr style="background-color: ${bg};">
                                    <td>${index + 1}</td>
                                    <td>${nature}</td>
                                    <td>${beneficiaire}</td>
                                    <td>${utils.formatCurrency(montantDH, 'DH')}</td>
                                    <td>${utils.formatDate(a.date_aide)}</td>
                                </tr>
                            `;
                        });

                        htmlTable += `</tbody></table></div>`;
                        await exportUtils.exportToPdf(htmlTable, 'liste_attributions');
                    } catch (e) {
                        console.error("Erreur PDF:", e);
                        utils.showNotification("Erreur export PDF", "error");
                    } finally {
                        utils.hideLoader();
                    }
                }
            },

            async loadStats() {
                try {
                    const currentYear = new Date().getFullYear();
                    const startDate = `${currentYear}-01-01`;
                    const endDate = `${currentYear}-12-31`;

                    // Fetch all attributions to calculate stats (or at least more than 10)
                    const { data, error } = await supabase.from('aides').select('*');
                    if (error) throw error;

                    const allAttributions = data || [];

                    // 1. Total Attribué (Année) EUR
                    const totalYearEUR = allAttributions
                        .filter(a => {
                            const date = a.date_aide || a.created_at;
                            return date && new Date(date).getFullYear() === currentYear;
                        })
                        .reduce((sum, a) => sum + utils.convertAmount(a.montant, 'EUR', 'EUR'), 0);

                    const totalYearEl = document.getElementById('totalYearAides');
                    if (totalYearEl) totalYearEl.textContent = utils.formatCurrency(totalYearEUR, 'EUR');

                    // 2. Bénéficiaires Actifs (montant > 0)
                    const uniqueBeneficiaries = new Set(
                        allAttributions
                            .filter(a => (Number(a.montant) || 0) > 0)
                            .map(a => a.id_veuve || a.id_orphelin)
                            .filter(id => !!id)
                    ).size;

                    const activeBeneficiariesEl = document.getElementById('activeBeneficiaries');
                    if (activeBeneficiariesEl) activeBeneficiariesEl.textContent = uniqueBeneficiaries;

                    // 3. Dernière Aide
                    if (allAttributions.length > 0) {
                        const sorted = [...allAttributions].sort((a, b) => new Date(b.date_aide || b.created_at) - new Date(a.date_aide || a.created_at));
                        const lastAid = sorted[0];

                        const lastAidAmountEl = document.getElementById('lastAidAmount');
                        if (lastAidAmountEl) lastAidAmountEl.textContent = utils.formatCurrency(lastAid.montant, 'EUR');

                        const lastAidDateEl = document.getElementById('lastAidDate');
                        if (lastAidDateEl) {
                            const date = lastAid.date_aide || lastAid.created_at;
                            lastAidDateEl.textContent = utils.formatDate(date);
                        }
                    }
                } catch (err) {
                    console.error('❌ Error loading aid stats:', err);
                }
            },

            async loadProgrammes() {
                const { data } = await supabase.from('programmes_aide').select('*').eq('actif', true);
                const container = document.getElementById('programmesContainer');

                if (!data || data.length === 0) {
                    container.innerHTML = `<div class="col-span-4 text-center text-gray-500" data-i18n="no_active_programs">${i18n.t('no_active_programs')}</div>`;
                    return;
                }

                const canWrite = await auth.canWrite();

                container.innerHTML = data.map(p => `
                    <div class="card p-5 hover:shadow-lg cursor-pointer group hover:-translate-y-1 transition-all relative">
                        <div class="flex justify-between items-start mb-3">
                            <div class="bg-blue-50 text-blue-600 p-2 rounded-lg group-hover:bg-blue-600 group-hover:text-white transition-colors">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <span class="text-xs font-semibold bg-gray-100 text-gray-600 px-2 py-1 rounded">${utils.formatCurrency(p.montant_standard)}</span>
                        </div>
                        <h4 class="font-bold text-gray-900 mb-1">${p.nom_programme}</h4>
                        <p class="text-sm text-gray-500 line-clamp-2">${p.description}</p>
                        ${canWrite ? `
                        <div class="absolute bottom-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="event.stopPropagation(); deleteProgramme('${p.id}', '${p.nom_programme}')" class="text-red-400 hover:text-red-600">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                        ` : ''}
                    </div>
                `).join('');
            },

            async loadAttributions() {
                const { data } = await supabase.from('aides')
                    .select('*, programmes_aide(nom_programme), veuves(nom_complet), orphelins(nom_complet)')
                    .order('date_aide', { ascending: false });

                this.allAttributions = data || [];
                const displayData = this.allAttributions.slice(0, 10);

                const tbody = document.getElementById('attributionsTableBody');

                if (!displayData || displayData.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center py-8" data-i18n="no_recent_activity">${i18n.t('no_recent_activity')}</td></tr>`;
                    return;
                }

                const canWrite = await auth.canWrite();

                tbody.innerHTML = displayData.map(a => {
                    return `
                        <tr>
                            <td class="font-medium text-gray-900">${a.nature_aide || a.programmes_aide?.nom_programme || 'Inconnu'}</td>
                            <td>
                                ${a.veuves ? `<div class="flex items-center gap-2"><span class="w-6 h-6 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xs">V</span> ${a.veuves.nom_complet}</div>` : ''}
                                ${a.orphelins ? `<div class="flex items-center gap-2"><span class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs">O</span> ${a.orphelins.nom_complet}</div>` : ''}
                            </td>
                            <td class="text-xs uppercase tracking-wide text-gray-500">${i18n.t(a.id_veuve ? 'widow' : 'orphan')}</td>
                            <td class="font-semibold text-gray-900">${utils.formatCurrency(a.montant, 'EUR')}</td>
                            <td class="text-gray-500">${utils.formatDate(a.date_aide)}</td>
                            <td><span class="badge ${statusClass}">${i18n.t('status_' + a.statut)}</span></td>
                            <td class="text-right">
                                ${canWrite ? `
                                <button onclick="aidesModule.deleteAttribution('${a.id}')" class="text-gray-400 hover:text-red-600" title="Supprimer">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                                ` : '-'}
                            </td>
                        </tr>
                    `;
                }).join('');
            },


            async deleteAttribution(id) {
                if (!await auth.canWrite()) {
                    utils.showNotification('Action non autorisée', 'error');
                    return;
                }
                const result = await Swal.fire({
                    title: i18n.t('delete_confirmation') || 'Êtes-vous sûr ?',
                    text: i18n.t('delete_warning') || "Cette action est irréversible !",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: i18n.t('delete') || 'Oui, supprimer',
                    cancelButtonText: i18n.t('cancel') || 'Annuler'
                });

                if (result.isConfirmed) {
                    try {
                        const { error } = await supabase
                            .from('aides')
                            .delete()
                            .eq('id', id);

                        if (error) throw error;

                        Swal.fire(
                            i18n.t('deleted') || 'Supprimé !',
                            i18n.t('attribution_deleted') || 'L\'attribution a été supprimée.',
                            'success'
                        );
                        this.loadAttributions();
                    } catch (error) {
                        console.error('Erreur:', error);
                        Swal.fire(
                            i18n.t('error') || 'Erreur',
                            i18n.t('delete_error') || 'Une erreur est survenue lors de la suppression.',
                            'error'
                        );
                    }
                }
            }
        };

        aidesModule.init();

        async function addNewProgram() {
            if (!await auth.canWrite()) {
                utils.showNotification('Action non autorisée', 'error');
                return;
            }
            const { value: formValues } = await Swal.fire({
                title: i18n.t('new_program'),
                html: `
                    <input id="swal-input1" class="swal2-input" placeholder="${i18n.t('prog_nature')}">
                    <select id="swal-input2" class="swal2-input">
                        <option value="financier">Financier</option>
                        <option value="materiel">Matériel</option>
                    </select>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: i18n.t('save_btn'),
                cancelButtonText: i18n.t('cancel'),
                preConfirm: () => {
                    return [
                        document.getElementById('swal-input1').value,
                        document.getElementById('swal-input2').value
                    ]
                }
            });

            if (formValues) {
                const [nom, type] = formValues;
                if (!nom) return;

                try {
                    const { error } = await supabase.from('programmes_aide').insert([{
                        nom_programme: nom,
                        type_aide: type,
                        statut: 'actif'
                    }]);

                    if (error) throw error;

                    Swal.fire(i18n.t('save'), 'Programme ajouté', 'success');
                    if (aidesModule && aidesModule.loadProgrammes) aidesModule.loadProgrammes();
                    else location.reload();
                } catch (e) {
                    console.error(e);
                    Swal.fire(i18n.t('error'), 'Erreur creation', 'error');
                }
            }
        }
    </script>
</body>

</html>